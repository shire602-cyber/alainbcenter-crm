# Fix for outboundDedupeKey Null Values

## Problem
The `outboundDedupeKey` field was added as nullable in the database migration, but existing rows have `null` values. When Prisma tries to query these rows, it fails because the schema expects a non-null value.

## Solution

### Option 1: Run the Fix Script (Recommended)

Run this SQL script to backfill existing null values:

```bash
psql $DATABASE_URL -f scripts/fix-outbound-dedupe-manual.sql
```

Or manually execute the SQL in `scripts/fix-outbound-dedupe-manual.sql`.

### Option 2: Wait for Migration

The migration `20250128140000_fix_outbound_dedupe_nullable` will automatically:
1. Backfill existing null values with generated keys
2. Update the unique index to allow nulls (partial index)

Run:
```bash
npx prisma migrate deploy
```

### What the Fix Does

1. **Backfills null values**: Generates unique keys for existing rows using pattern:
   ```
   legacy_{id}_{conversationId}_{triggerProviderMessageId}_{timestamp}
   ```

2. **Updates unique index**: Changes from full unique index to partial unique index:
   ```sql
   CREATE UNIQUE INDEX ... WHERE "outboundDedupeKey" IS NOT NULL;
   ```
   This allows multiple NULLs while enforcing uniqueness for non-null values.

3. **Schema update**: Made `outboundDedupeKey` nullable in Prisma schema (`String?`)

### Code Changes

- Health endpoint now filters out null `outboundDedupeKey` rows
- All new outbound messages will always have a `outboundDedupeKey` (generated by `sendOutboundWithIdempotency`)
- Legacy rows are handled gracefully

### Verification

After running the fix, verify:

```sql
SELECT 
  COUNT(*) as total_rows,
  COUNT("outboundDedupeKey") as rows_with_key,
  COUNT(*) - COUNT("outboundDedupeKey") as rows_without_key
FROM "OutboundMessageLog";
```

Should show `rows_without_key = 0`.

